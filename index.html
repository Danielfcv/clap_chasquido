<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vista de modelo — Teachable Machine (Audio)</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial; margin:0; background:#f7f7fb}
    .wrap{max-width:860px; margin:32px auto; padding:0 18px 42px}
    .card{background:#fff; border-radius:14px; box-shadow:0 10px 24px rgba(2,6,23,.06),0 2px 6px rgba(2,6,23,.06); padding:16px}
    h1{font-size:22px; margin:0 0 8px}
    .lead{color:#334155; margin:0 0 16px}
    .controls{display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin-bottom:12px}
    button{border:0; background:#111827; color:#fff; padding:10px 14px; border-radius:999px; cursor:pointer; font-weight:600}
    .grid{display:grid; grid-template-columns:160px 1fr; gap:10px 16px; align-items:center}
    .class-name{font-weight:600; color:#111827; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .bar{height:10px; background:#eef2ff; border-radius:999px; overflow:hidden}
    .fill{height:100%; width:0%; background:#6366f1; transition:width .12s linear}
    .row{display:contents}
    .status{margin-top:12px; font-weight:600; color:#111827}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Vista del modelo (Audio)</h1>
    <p class="lead">Usa el micrófono y muestra la clase más probable y sus probabilidades.</p>
    <div class="controls"><button id="startBtn">Iniciar micrófono</button></div>
    <div id="labels" class="grid"></div>
    <div id="status" class="status">Listo.</div>
  </div>
</div>

<!-- ===== Librerías: TFJS primero, luego TM Audio ===== -->
<!-- TensorFlow.js -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.21.0/dist/tf.min.js"></script>

<!-- Teachable Machine audio (UMD) -->
<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/audio@0.8.6/dist/teachablemachine-audio.min.js"></script>

<!-- Fallback opcional: ESM si el UMD está bloqueado -->
<script type="module">
  if (!window.tmAudio) {
    try {
      const mod = await import('https://cdn.jsdelivr.net/npm/@teachablemachine/audio@0.8.6/dist/teachablemachine-audio.esm.js');
      window.tmAudio = mod;
      console.info('tmAudio cargado vía ESM (jsDelivr).');
    } catch (e) {
      try {
        const mod = await import('https://unpkg.com/@teachablemachine/audio@0.8.6/dist/teachablemachine-audio.esm.js');
        window.tmAudio = mod;
        console.info('tmAudio cargado vía ESM (unpkg).');
      } catch (err) {
        console.error('No se pudo cargar tmAudio desde los CDNs.', err);
      }
    }
  }
</script>

<!-- ===== App ===== -->
<script>
  // URL de tu modelo (debe terminar con "/")
  const URL = "https://teachablemachine.withgoogle.com/models/vddFqxPQn/";

  let model, mic, labels = [];
  const labelsEl = document.getElementById('labels');
  const statusEl = document.getElementById('status');
  document.getElementById('startBtn').addEventListener('click', init);

  function buildUI(names){
    labelsEl.innerHTML = '';
    names.forEach(name=>{
      const nameDiv = document.createElement('div');
      nameDiv.className = 'class-name'; nameDiv.textContent = name;
      const bar = document.createElement('div'); bar.className = 'bar';
      const fill = document.createElement('div'); fill.className = 'fill'; bar.appendChild(fill);
      const row = document.createElement('div'); row.className = 'row';
      row.appendChild(nameDiv); row.appendChild(bar); labelsEl.appendChild(row);
    });
  }

  function render(preds){
    let top = preds[0];
    preds.forEach((p,i)=>{
      if(p.probability>top.probability) top=p;
      const row = labelsEl.children[i]; const fill=row.querySelector('.fill');
      fill.style.width = (p.probability*100).toFixed(1)+'%';
    });
    statusEl.textContent = `Top: ${top.className} (${top.probability.toFixed(2)})`;
  }

  async function init(){
    try{
      statusEl.textContent = 'Cargando modelo…';
      if (!window.tmAudio) throw new Error('La librería de TM audio no cargó (revisa CDNs o bloqueadores).');

      const modelURL = URL + "model.json";
      const metadataURL = URL + "metadata.json";
      model = await window.tmAudio.load(modelURL, metadataURL);

      mic = new window.tmAudio.Microphone();
      await mic.setup(); await mic.play();

      const first = await model.predict(mic);
      labels = first.map(p=>p.className); buildUI(labels); render(first);
      statusEl.textContent = 'Escuchando…';
      loop();
    }catch(err){
      console.error(err); statusEl.textContent = "Error: " + (err.message||err);
    }
  }

  async function loop(){
    if(!model || !mic) return;
    try{ const preds = await model.predict(mic); render(preds); }
    catch(e){ console.error(e); }
    requestAnimationFrame(loop);
  }
</script>
</body>
</html>

